{% extends 'basic.html' %}
{% block title%} {{IPOName}}-App.-Sell Order Detail{% endblock %}
{% block css %}
{% load static %}
<!-- ADD NEW CODE DELETE CSS -->

<style>
    {% comment %} body {
        font-family: Arial, Helvetica, sans-serif;
    } {% endcomment %}
    a:not([href]):not([tabindex]) {
        color: #ffffff;
        text-decoration: none;
    }

    .Shadow1 {
        position: absolute;
        background-color: #efebeb;
        color: #f30a0a;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

    * {
        box-sizing: border-box;
    }
    .navbar{
        padding: 0.5rem 0rem !important;
    }

    .h3,
    h3 {
        margin-top: 85px;
        font-size: 1.75rem;
        border-block-end: 3px solid #e9ecef;
    }

    .iponame {
        background-color: white;
        height: 35px;
        margin: 35px 0px;
        width: 100%;
        text-align: center;
    }

    .col-md-3 {
        display: contents;
    }


    .footer {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        background-color: #686868;
        color: white;
        text-align: center;
        padding: 5px 0px;
    }

    .button {
        margin: 0px 10px;
        color: black;
        background-color: antiquewhite;
        width: auto;
    }

    .btn-dark.disabled,
    .btn-dark:disabled {
        color: #000;
        background-color: #ffddaf;
        border-color: #040404;
    }

    table {
        border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
        border: 1px solid #ddd;
    }

    th,
    td {
        text-align: center;
        padding: 5px;
    }

    tr:nth-child(even) {
        background-color: #f2f2f2
    }

    table.table-sortable th.currently-sorted[data-sort-dir="asc"]::after {
        content: "\25b2";

    }

    table.table-sortable th.currently-sorted[data-sort-dir="desc"]::after {
        content: "\25bc";

    }

    .container {
        width: 100%;
        padding-right: 25px;
        padding-left: 25px;
        margin-right: auto!important;
        margin-left: auto!important;
    }
    .form-group {
        margin-bottom: 0.5rem;
    }
    {% comment %} #ipo_register, #secondary_dropdown {
        width: 460px; /* Set the width you want for the dropdowns */
    }
    #ipo_register options{
        width: 460px; /* Set the width you want for the dropdowns */
    } {% endcomment %}

    {% comment %} @media (max-width: 767px) {

        .h3,
        h3 {
            margin-top: 80px;
            font-size: 1.75rem;
            border-block-end: 3px solid #e9ecef;
        }

        .iponame {
            background-color: white;
            height: 35px;
            margin: 55px 0px;
            width: 100%;
        }

        .containerhight {
            margin-bottom: 100%;
        }


        .modal-content {
            position: relative;
            width: 35%;
        }


        .footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #686868;
            color: white;
            text-align: center;
            padding: 5px 0px;
            display: grid;
        }

        .button {
            margin: 0px 5px;
            color: black;
            background-color: antiquewhite;
            width: 98%;
        }
    } {% endcomment %}

    @media screen and (min-width: 1903px) and (max-width: 1950px) {

        .dnn{
            display: none;
        }
        .buc{
            margin-left: 91.5%;
            margin-top: -3.0%!important;
        }
        .sec{
            margin-left:   13.47%;
        }
        .iac{
            margin-left: 1.5%;
        }
        .bu{
            margin-left: 1.7%;
        }
        .smebucc {
            margin-left: 5%;
            margin-top: 2% !important;
        }
        .smesecy{
            margin-left:8.17%;
        }
        .smebucy{
            margin-left: 4%;
        }
        .iacs{
            margin-left: 4.5%;
        }
        .fma {
            margin-right: 55% !important;
        }
        
    }

    @media screen and (min-width: 1795px) and (max-width: 1902px) {

        .dnn{
            display: none;
        }
        .buc{
            margin-left: 91.5%;
            margin-top: -3.0%!important;
        }
        .sec{
            margin-left:   13%;
        }
        .iac{
            margin-left: 1.5%;
        }
        .bu{
            margin-left: 1.7%;
        }
        .smebucc {
            margin-left: 5%;
            margin-top: 2% !important;
        }
        .smesecy{
            margin-left:7.1%;
        }
        .smebucy{
            margin-left: 4%;
        }
        .iacs{
            margin-left: 4.5%;
        }
        .fma {
            margin-right: 55% !important;
        }
        
    }

    @media screen and (min-width: 1695px) and (max-width: 1794px) {

        .dnn{
            display: none;
        }
        .buc{
            margin-left: 91.5%;
            margin-top: -3.0%!important;
        }
        .sec{
            margin-left:   12.5%;
        }
        .iac{
            margin-left: 1.5%;
        }
        .bu{
            margin-left: 1.7%;
        }
        .smebucc {
            margin-left: 5%;
            margin-top: 2% !important;
        }
        .smesecy{
            margin-left:7.1%;
        }
        .smebucy{
            margin-left: 4%;
        }
        .iacs{
            margin-left: 4.5%;
        }
        .fma {
            margin-right: 55% !important;
        }
        
    }

    @media screen and (min-width: 1631px) and (max-width: 1694px) {
        .secy{
            margin-left: 13.8%;
        }
        .smesecy{
            margin-left: 5%;
        }
        .bucc {
            margin-left: 4%;
        }
        .smebucc {
            margin-left: 6%;
        }
        .smebucy{
            margin-left: 5.5%;
        }

        .bucy{
            margin-left: 4%;
        }

        .dnn{
            display: none;
        }
       
        .buc{
            margin-left: 19%;
            margin-top: 8.4%!important;
        }
        .bu{
            margin-left: 1%;
        }
        .iac{
            margin-left: 0.7%;
        }
        .iacs{
            margin-left: 5%;
        }
        .fma {
            margin-right: 55% !important;
        }
    }

    @media screen and (min-width: 1500px) and (max-width: 1630px) {
        .smesecy{
            margin-left: 4%;
        }
        .bucc {
            margin-left: 4%;
        }
        .smebucc {
            margin-left: 6%;
        }
        .smebucy{
            margin-left: 5.5%;
        }

        .bucy{
            margin-left: 1%;
        }

        .dnn{
            display: none;
        }
        .sec{
            margin-left: 12.5%;
        }
        .buc{
            margin-left: 1.9%;
            margin-top: 2.3% !important;
        }
        .bu{
            margin-left: 1.3%;
        }
        .iac{
            margin-left: 1%;
        }
        .iacs{
            margin-left: 5%;
        }
        .fma {
            margin-right: 55% !important;
        }
    }

    @media screen and (min-width: 1400px) and (max-width: 1499px) {
        .smesecy{
            margin-left: 3%;
        }
        .bucc {
            margin-left: 4%;
        }
        .smebucc {
            margin-left: 6%;
        }
        .smebucy{
            margin-left: 5.5%;
        }

        .bucy{
            margin-left: 4%;
        }

        .dnn{
            display: none;
        }
        .sec{
            margin-left: 8%;
        }
        .buc{
            margin-left: 87%;
            margin-top: 1% !important;
        }
        .bu{
            margin-left: 3%;
        }
        .iac{
            margin-left: 3%;
        }
        .iacs{
            margin-left: 5%;
        }
        .fma {
            margin-right: 55% !important;
        }
    }

    @media screen and (min-width: 1358px) and (max-width: 1399px) {
        .smesecy{
            margin-left: 3%;
        }
        .bucc {
            margin-left: 4%;
        }
        .smebucc {
            margin-left: 6%;
        }
        .smebucy{
            margin-left: 5.5%;
        }

        .bucy{
            margin-left: 4%;
        }

        .dnn{
            display: none;
        }
        .sec{
            margin-left: 7.5%;
        }
        .buc{
            margin-left: 87%;
            margin-top: 1% !important;
        }
        .bu{
            margin-left: 3%;
        }
        .iac{
            margin-left: 3%;
        }
        .iacs{
            margin-left: 5%;
        }
        .fma {
            margin-right: 55% !important;
        }
    }

    @media screen and (min-width: 1200px) and (max-width: 1357px) {
        .smesecy{
            margin-left: 1%;
        }
        .bucc {
            margin-left: 4%;
        }
        .smebucc {
            margin-left: 6%;
        }
        .smebucy{
            margin-left: 5.5%;
        }

        .bucy{
            margin-left: 4%;
        }

        .dnn{
            display: none;
        }
        .sec{
            margin-left: 5.5%;
        }
        .buc{
            margin-left: 87%;
            margin-top: 1% !important;
        }
        .bu{
            margin-left: 3.4%;
        }
        .iac{
            margin-left: 3%;
        }
        .iacs{
            margin-left: 5%;
        }
        .fma {
            margin-right: 55% !important;
        }
    }

    @media screen and (min-width: 992px) and (max-width: 1199px) {
        .secy{
            margin-left: 0.5%;
            margin-top: 10% !important;
        }
        .smesecy{
            margin-left: -2.5%;
        }
        .smebucy{
            margin-left: 6%;
        }
        .smebucc{
            margin-left: -7%;
            margin-top:9% !important;
        }

        .bucy{
            margin-left: 36%;
            margin-top: 10% !important;
        }
        .bucc{
            margin-left: 33%;
            margin-top: 10% !important;
        }

        .dnn{
            display: none;
        }
        .sec{
            margin-left: 9.5%;
            margin-top: 3.5%!important;
        }
        .buc{
            margin-left: 18%;
            margin-top: 8.4%!important;
        }
        .bu{
            margin-left: 9.5%;
            margin-top: 3.5%!important;
        }
        .se{
            margin-left: 0%;
        }
        .iac{
            margin-left: 84%;
            margin-top: 1%!important;
        }
        .iacs{
            margin-left: 5.5%;
        }
        .fma {
            margin-right: 55% !important;
        }
    }

    @media screen and (min-width: 576px) and (max-width: 767px) {
        .iponame {
            margin-top: 54px;         
        } 

        .fc{
            margin-top: 13%!important;
        }

        .footer{
            position: sticky;
            top: 100vh;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #686868;
            color: white;
            text-align: center;
            padding: 5px 0px;
            display: grid;
        }
    }

    @media screen and (min-width: 280px) and (max-width: 575px) {
        .iponame {
            margin-top: 54px;         
        } 

        .fc{
            margin-top: 13%!important;
        }

        .footer{
            position: sticky;
            top: 100vh;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #686868;
            color: white;
            text-align: center;
            padding: 5px 0px;
            display: grid;
        }
    }

    @media screen and (min-width: 880px) and (max-width: 991px) {
        .sec{
            margin-left: 31%;
            margin-top: 1%!important;
        }

        .buc{
            margin-left: 5%;
            margin-top: 1%!important;
        }
        .bu{
            margin-left: 4%;
            margin-top: 1%!important;
        }
        .bus{
            margin-left: 12%;
            margin-top: 1%!important;
        }

        .se{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .iac{
            margin-left: 5%;
            margin-top: 1%!important;
        }
        .iacs{
            margin-left: 12%;
            margin-top: 1%!important;
        }

        .ses{
            margin-left: 24%; 
            margin-top: 1%!important;
        }

        .bucs{
            margin-left: 10%;
            margin-top: 0%!important;
        }

        .dnn{
            display: none;
        }
        .fma {
            margin-right: 55% !important;
        }

    }

    @media screen and (min-width: 768px) and (max-width: 879px) {
        .sec{
            margin-left: 30%;
            margin-top: 1%!important;
        }

        .buc{
            margin-left: 6%;
            margin-top: 1%!important;
        }
        .bu{
            margin-left: 4%;
            margin-top: 1%!important;
        }
        .bus{
            margin-left: 10%;
            margin-top: 1%!important;
        }
        .iac{
            margin-left: 3%;
            margin-top: 1%!important;
        }
        .iacs{
            margin-left: 9%;
            margin-top: 1%!important;
        }

        .se{
            margin-left: 0%;
            margin-top: 1%!important;
        }

        .ses{
            margin-left: 26.5%;
            margin-top: 1%!important;
        }

        .bucs{
            margin-left: 10%;
            margin-top: 0% !important;
        }

        .dnn{
            display: none;
        }
        .fma {
            margin-right: 55% !important;
        }

    }

    @media screen and (min-width: 672px) and (max-width: 767px) {
        .sec{
            margin-left: 19%;
            margin-top: 1%!important;
        }

        .buc{
            margin-left: -6%;
            margin-top: 9%!important;
        }
        .bu{
            margin-left: 16%;
            margin-top: 1%!important;
        }
        .bus{
            margin-left: 18%;
            margin-top: 0%!important;
        }
        .iac{
            margin-left: 16%;
            margin-top: 1%!important;
        }
        .iacs{
            margin-left: 16%;
            margin-top: 0%!important;
        }

        .se{
            margin-left: 0%;
            margin-top: 1%!important;
        }

        .ses{
            margin-left: 25%;
            margin-top: 1px!important;
        }

        .bucs{
            margin-left: 16%;
            margin-top: 0% !important;
        }

        .dnn{
            display: none;
        }
        .fma {
            margin-right: 55% !important;
        }

    }

    @media screen and (min-width: 576px) and (max-width: 671px) {
        .sec{
            margin-left: 18%;
            margin-top: 1%!important;
        }
        .bu{
            margin-left: 17%;
            margin-top: 1%!important;
        }
        .bus{
            margin-left: 27%;
            margin-top: 0%!important;
        }
        .iac{
            margin-left: 16%;
            margin-top: 1%!important;
        }
        .iacs{
            margin-left: 28%;
            margin-top: 0%!important;
        }

        .buc{
            margin-left: -8%;
            margin-top: 11%!important;
        }

        .se{
            margin-left: 0%;
            margin-top: 1%!important;
        }

        .ses{
            margin-left: 0.1%;
            margin-top: 1px!important;
        }

        .bucs{
            margin-left: -5%;
            margin-top: 10%!important;
        }

        .dnn{
            display: none;
        }
        .fma {
            margin-right: 55% !important;
        }

    }

    @media screen and (min-width: 487px) and (max-width: 575px) {
        .sec{
            margin-left: 31%;
            margin-top: -10% !important;
        }
        .smesecy{
            margin-left: 32%;
            margin-top: -10%!important;
        }
        .bus{
            margin-left: 69.5%;
            margin-top: -10.5%!important;
        }
        .iacs{
            margin-left: 66%;
            margin-top: 0%!important;
        }
        .bu{
            margin-left: 71%;
            margin-top: -10% !important;
        }
        .iac{
            margin-left: 67.5%;
            margin-top: 0% !important;
        }

        .buc{
            margin-left: 68%;
            margin-top: -13%!important;
        }
        .bucc{
            margin-left: 4%;
            margin-top: -13%!important;
        }
        
        .smebucc{
            margin-left: 4%;
            margin-top: -12%!important;
        }

        .se{
            margin-left: -67%;
            margin-top: 24%!important;
        }
        .bucs{
            margin-left: 70.3%;
            margin-top: -12%!important;
        }

        .dn{
            display: none;
        }
        .fma {
            margin-right: 49% !important;
        }
    }

    @media screen and (min-width: 445px) and (max-width: 486px) {
        .sec{
            margin-left: 33%;
            margin-top: -11%!important;
        }
        .smesecy{
            margin-left: 32%;
            margin-top: -11%!important;
        }

        .bu{
            margin-left: 69%;
            margin-top: -11.5%!important;
        }
        .bus{
            margin-left: 66%;
            margin-top: -11.5%!important;
        }
        .iac{
            margin-left: 65%;
            margin-top: 0%!important;
        }
        .iacs{
            margin-left: 62%;
            margin-top: 0%!important;
        }
        .buc{
            margin-left: 68%;
            margin-top: -13%!important;
        }
        .bucc{
            margin-left: 4%;
            margin-top: -13%!important;
        }
        .bucs{
            margin-left: -0.3%;
            margin-top: -14%!important;
        }

        .se{
            margin-left: -66%;
            margin-top: 22%!important;
        }

        .dn{
            display: none;
        }
        .fma {
            margin-right: 44% !important;
        }
    }

    @media screen and (min-width: 418px) and (max-width: 444px) {
        .sec{
            margin-left: 63%;
            margin-top: -12%!important;
        }
        .smesecy{
            margin-left: 63%;
            margin-top: -12%!important;
        }

        .bu{
            margin-left: 1%;
            margin-top: 1%!important;
        }
        .bus{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .iac{
            margin-left: 60%;
            margin-top: -12%!important;
        }
        .iacs{
            margin-left: 60%;
            margin-top: -12%!important;
        }

        .buc{
            margin-left: 1%;
            margin-top: 1%!important;
        }
        .smebucc{
            margin-left: 0%;
            margin-top: 1%!important;
        }

        .se{
            margin-left: -66%;
            margin-top: 27%!important;
        }

        .dn{
            display: none;
        }
        .fma {
            margin-right: 38% !important;
        }
    }

    @media screen and (min-width: 361px) and (max-width: 417px) {
        .sec{
            margin-left: 57%;
            margin-top: -14%!important;
        }
        .smesecy{
            margin-left: 58%;
            margin-top: -14%!important;
        }

        .bu{
            margin-left: 1%;
            margin-top: -1% !important;
        }
        .iac{
            margin-left: 53%;
            margin-top: -14%!important;
        }

        .bucc{
            margin-left: -5%;
            margin-top: -9%!important;
        }
        .buc{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .bucs{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .smebucy{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .iacs{
            margin-left: 54%;
            margin-top: -14%!important;
        }
        
        .se{
            margin-left: -65%;
            margin-top: 26%!important;
        }

        .dn{
            display: none;
        }
        .fma {
            margin-right: 26% !important;
        }
        
    }

    @media screen and (min-width: 329px) and (max-width: 360px) {
        .sec{
            margin-left: 54%;
            margin-top: -15%!important;
        }
        .smesecy{
            margin-left: 57%;
            margin-top: -16%!important;
        }

        .bu{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .iac{
            margin-left: 50%;
            margin-top: -15%!important;
        }
        .iacs{
            margin-left: 52%;
            margin-top: -15%!important;
        }
        .smebucy{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .iponame{
            font-size: 7vw !important;
        }

        .bucc{
            margin-left: -5%;
            margin-top: -11%!important;
        }
        .smebucc{
            margin-left: 0%;
            margin-top: -1%!important;
        }

        .se{
            margin-left: -67%;
            margin-top: 31%!important;
        }

        .dn{
            display: none;
        }
        .fma {
            margin-right: 18% !important;
        }
        
    }

    @media screen and (min-width: 280px) and (max-width: 328px) {
        .sec{
            margin-left: 0%;
            margin-top: 1%!important;
        }

        .bu{
            margin-left: 46%;
            margin-top: 1%!important;
        }
        .iac{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .iponame{
            font-size: 7vw !important;
        }

        .bucc{
            margin-left: -7%;
            margin-top: 1%!important;
        }
        .bucy{
            margin-left: 57%;
            margin-top: -18.5% !important;
        }
        .smesecy{
            margin-left: 50%;
            margin-top: -19.5%!important;
        }
        .smebucc{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .smebucy{
            margin-left: 0%;
            margin-top: 1%!important;
        }
        .iacs{
            margin-left: 0%;
            margin-top: 2%!important;
        }

        .se{
            margin-left: 0%;
            margin-top: 13%!important;
        }

        .dn{
            display: none;
        }
        .fma {
            margin-right: 6% !important;
        }
    }

    @media (min-width: 768px) and (max-width: 1157px) {
        .fc{
            margin-bottom: 25%!important;
        }
    }
</style>

<!-- <link rel="stylesheet" href="{% static 'CSS/jquery-ui.css' %}"> -->

<script src="{% static 'JS/xlsx.full.min.js' %}"></script>

{% endblock %}

{% block body %}


{% csrf_token %}

{% comment %} <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>

<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script> {% endcomment %}


<!-- Alert MESSAGE CODE AND SCRIPT -->
{% if messages %}
    {# The main container for all messages. Initially set to a generic 'alert-info' or 'alert-success' #}
    {# JavaScript will change this class to 'alert-danger' if errors are found. #}
    <div class="alert alert-info fixed-top" id="all-messages-popup" role="alert" style="max-width: 1500px; position: fixed; max-height: 400px; overflow-y: scroll; top: 46%; left: 46%; transform: translate(-41%, -50%); z-index: 1050; display: none;">
        <div class="modal-header" style="border-bottom: 1px solid black;">
            <h5 class="modal-title" id="messageModalLabel">Messages</h5> {# Default title #}
            <button type="button" class="close" data-dismiss="alert">x</button>
        </div>
        
        <form method="POST" action="/ErrorCSV">
            <div class="modal-body" id="message-list-container"> {# Added ID to this div to append messages #}
                {% csrf_token %}
                {# This hidden input's value will be set by JavaScript #}
                <input type="hidden" id="csvErrorMessages" name="name" value="">
                
                {# Render all messages here with their original tags as a data attribute #}
                {% for message in messages %}
                    <strong class="template-message" data-tags="{{ message.tags }}" {% if 'error' in message.tags %}style="color: red;"{% endif %}>{{ message }}</strong><br>
                {% endfor %}
            </div>
            
            <div class="modal-footer" style="border-top: 1px solid black; color: rgb(44, 9, 9); display: none;" id="error-footer"> {# Initially hidden #}
                <button type="submit" id="downloadErrorCsvButton" >Download CSV File</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const allMessagesPopup = $('#all-messages-popup');
            const messageModalLabel = $('#messageModalLabel');
            const errorFooter = $('#error-footer');
            const csvErrorMessagesInput = $('#csvErrorMessages');
            let hasErrors = false;
            let hasinfo = false;
            let errorMessagesForCsv = [];

            // Iterate over each message element rendered by Django
            $('.template-message').each(function() {
                const messageText = $(this).text();
                const messageTags = $(this).data('tags'); // Get tags from data attribute
                // Check if the message has 'error' tag
                if (messageTags && messageTags.includes('alert-danger')) {
                    hasErrors = true;
                    errorMessagesForCsv.push(messageText);
                }
                if (messageTags && messageTags.includes('alert-info')) {
                    hasinfo = true;
                    errorMessagesForCsv.push(messageText);
                }
            });

            // Update popup styling and content based on whether errors were found
            if (hasErrors) {
                allMessagesPopup.removeClass('alert-info').addClass('alert-danger');
                messageModalLabel.text('Errors');
                errorFooter.show(); // Show the download button
                csvErrorMessagesInput.val(errorMessagesForCsv.join('\n')); // Set CSV data
                
                // Auto-click download button if errors are present
                setTimeout(function() {
                    const downloadButton = document.getElementById('downloadErrorCsvButton');
                    if (downloadButton) {
                        downloadButton.click();
                    }
                }, 1000); // Clicks the button after 1 second
            } else if(hasinfo){
                allMessagesPopup.removeClass('alert-info').addClass('alert-danger');
                messageModalLabel.text('Errors');

            } else {
                allMessagesPopup.removeClass('alert-info').addClass('alert-success');
                messageModalLabel.text('Messages');
                // Hide the alert after a delay if it's NOT an error message with a download button
                setTimeout(function() {
                    allMessagesPopup.slideUp(500, function() {
                        $(this).remove(); // Remove after sliding up
                    });
                }, 5000); // Disappears after 5 seconds if not an error message
            }

            // Finally, show the consolidated popup
            allMessagesPopup.show();

            // Close button functionality for the modal
            allMessagesPopup.find('.close').on('click', function() {
                allMessagesPopup.hide(); // Hide the modal when close button is clicked
            });
        });
    </script>
{% endif %}


<div class="container fc" style="margin: 2px; margin-bottom: 5%; max-width: 100vw;">
    <h3 class="fixed-top iponame" style="z-index: 9; position: fixed;">{{ IPOName.IPOName}}</h3>

    <h3>App.-Sell Order Detail</h3><br>

    <div class="form-row">
        <div class="form-group col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
            <form method="POST" action="/{{IPOid}}/OrderDetail/SELL" name="filter" novalidate>
                {% csrf_token %}
                <div class="form-row">
                    <div class="form-group col-xl-2 col-lg-2 col-md-4 col-sm-4 col-8">
                        <label for="category"><b>Group</b></label>
                        <select id="category" class="form-control" name="Groupfilter" autofocus="autofocus"
                            >
                            <option selected>All</option>
                            {% for i in Group %}
                            <option {% if Groupfilter == i.GroupName %} selected {%else%} {% endif %}
                                value="{{ i.GroupName }}">
                                {{i.GroupName }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% comment %} <div class="form-group col-md-1"></div> {% endcomment %}
                    <div class="form-group col-xl-2 col-lg-2 col-md-4 col-sm-4 col-8">
                        <label for="category"><b>Order Category</b></label>
                        <select id="category1" class="form-control" name="IPOTypefilter">
                            <option selected>All</option>
                            <option {% if IPOTypefilter == 'Kostak'%} selected {% endif %} value="Kostak">Kostak</option>
                            <option {% if IPOTypefilter == 'Subject To'%} selected {% endif %} value="Subject To">Subject To</option>
                        </select>
                    </div>

                    {% if IPOName.IPOType == "MAINBOARD" %} 
                    <!-- {% comment %} <div class="form-group col-md-1"></div> {% endcomment %} -->
                    <div class="form-group col-xl-2 col-lg-2 col-md-4 col-sm-4 col-8">
                        <label for="category"><b>Investor Type</b></label>
                        <select id="category2" class="form-control" name="InvestorTypeFilter">
                            <option {% if InvestorTypeFilter == 'All' or InvestorTypeFilter == 'None' %} selected {% endif %} value="All">All</option>
                            <option {% if InvestorTypeFilter == 'RETAIL'%} selected {% endif %} value="RETAIL">Retail </option>
                            <option {% if InvestorTypeFilter == 'SHNI'%} selected {% endif %} value="SHNI">SHNI </option>
                            <option {% if InvestorTypeFilter == 'BHNI'%} selected {% endif %} value="BHNI">BHNI </option>
                            <!-- <option {% if InvestorTypeFilter == 'PREMIUM' %} selected {% endif %} value="PREMIUM">Premium</option> -->
                        </select>
                    </div>

                    {%endif%}
                    <!-- <div class="form-group col-md-2" style="margin-top: 33px;"> -->

                    <!-- {% comment %} <div class="form-group col-md-1"></div> {% endcomment %} -->

                    {% if IPOName.IPOType == "MAINBOARD" %} 
                    <div class="form-group col-xl-1 col-lg-1 col-md-1 col-sm-1 col-3 se " style="margin-top: 33px;">
                        <button type="submit" class="btn btn-primary">Search &nbsp; <i class="fa fa-search"
                                aria-hidden="true" style='font-size:18px;'></i>
                        </button>
                    </div>
                    <div class="form-group col-xl-1 col-lg-1 col-md-2 col-sm-1 sec secy " style="margin-top: 33px; ">
                        <button type="button" class="btn btn-secondary " data-toggle="modal"
                        data-target="#exampleModals">Download &nbsp; <i class="fa fa-download" aria-hidden="true"
                                style='font-size:18px;'></i>
                        </button>
                    </div>
                    <div class="form-group col-xl-1 col-lg-1 col-md-2 col-sm-1 bu bucy " style="margin-top: 33px;">
                        <button type="button" class="btn btn-secondary "  data-toggle="modal" data-target="#exampleModal">Bulk
                            Order &nbsp;<i class="fa fa-file-excel-o" aria-hidden="true" style='font-size:18px;'></i>
                        </button>
                    </div>
                    <div class="form-group col-xl-1 col-lg-1 col-md-2 col-sm-1 iac " style="margin-top: 33px;">
                        {% if is_premium_user  == 'True' %}
                            <button type="button" class="btn btn-secondary "  data-toggle="modal" data-target="#IPO_Allotment_Check">Check
                                Allotment 
                            </button>
                        {% else %}
                            <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#editbtn" >Firm Allotment</button>
                        {% endif %} 
                    </div>

                    {%endif%}

                    {% if IPOName.IPOType == "SME" %} 
                    <div class="form-group col-xl-1 col-lg-1 col-md-1 col-sm-1 " style="margin-top: 33px;">
                        <button type="submit" class="btn btn-primary">Search &nbsp; <i class="fa fa-search"
                                aria-hidden="true" style='font-size:18px;'></i>
                        </button>
                    </div>
                    {%endif%}
                    
                    {% if IPOName.IPOType == "SME" %} 
                    <div class="form-group col-xl-2 col-lg-2 col-md-2 col-sm-2 dn"></div>

                    <div class="form-group col-xl-1 col-lg-1 col-md-2 col-sm-1 ses smesecy " style="margin-top: 33px; ">
                        <button type="button" class="btn btn-secondary " data-toggle="modal"
                        data-target="#exampleModals">Download &nbsp; <i class="fa fa-download" aria-hidden="true"
                                style='font-size:18px;'></i>
                        </button>
                    </div>
                    <div class="form-group col-xl-1 col-lg-1 col-md-2 col-sm-1 bus smebucy " style="margin-top: 33px;">
                        <button type="button" class="btn btn-secondary "  data-toggle="modal" data-target="#exampleModal">Bulk
                            Order &nbsp;<i class="fa fa-file-excel-o" aria-hidden="true" style='font-size:18px;'></i>
                        </button>
                    </div>
                    <div class="form-group col-xl-1 col-lg-1 col-md-2 col-sm-1 iacs  " style="margin-top: 33px;">
                        {% if is_premium_user  == 'True' %}
                            <button type="button" class="btn btn-secondary "  data-toggle="modal" data-target="#IPO_Allotment_Check">Check
                                Allotment 
                            </button>
                        {% else %}
                            <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#editbtn">Firm Allotment</button>
                        {% endif %}    
                    </div>
                    {%endif%}    
                </div>

            </form>
        </div>
        <div class="form-group col-md-4" >

            <!--NEW  Modal FOR BULK ORDER BUTTON-->
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabels"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header" style="border-bottom: 1px solid black;">
                            <h5 class="modal-title" id="exampleModalLabel">Bulk Order &nbsp;<i
                                    class="fa fa-file-excel-o" aria-hidden="true" style='font-size:18px;'></i></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            {{prompt}}
                            <form {% if IPOName.IPOType == "MAINBOARD" %} action="/{{IPOid}}/SELL/upload-csv/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}" {% else %} action="/{{IPOid}}/SELL/upload-csv/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}" {%endif%} method="POST" enctype="multipart/form-data"
                                class="needs-validation" novalidate>
                                {% csrf_token %}
                                <small style="color: red;">
                                    <b>
                                        <font color="red">*</font>Only accepts CSV files.<i class="fa fa-file-excel-o"
                                            aria-hidden="true" style='font-size:18px;'></i>
                                    </b>
                                </small><br><br>

                                <input type="file" id="file" class="form-control" name=" file"
                                    style="background: darkslategrey; color: white; height: 0%;width: 70%; display: inline-flex;"
                                    required>

                                <button type="submit"
                                    style="color: whitesmoke; background: darkslategrey; width: 25%; margin: 0px 150x; border: none; padding: 8px 0; border-radius: 2px; height: 38px;">Upload
                                    &nbsp; <i class="fa fa-file-excel-o" aria-hidden="true"
                                        style='font-size:18px;'></i></button>
                                <div class="invalid-feedback">
                                    Choose Your File.
                                </div>
                            </form>
                            {% for profile in entry%}
                            {{profile.name}}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- JAVASCRIPT FOR FLIE UPDAT BUTTON FORM VALIDATION -->
                <script>
                    // Example starter JavaScript for disabling form submissions if there are invalid fields
                    (function () {
                        'use strict'

                        // Fetch all the forms we want to apply custom Bootstrap validation styles to
                        var forms = document.querySelectorAll('.needs-validation')

                        // Loop over them and prevent submission
                        Array.prototype.slice.call(forms)
                            .forEach(function (form) {
                                form.addEventListener('submit', function (event) {
                                    if (!form.checkValidity()) {
                                        event.preventDefault()
                                        event.stopPropagation()
                                    }

                                    form.classList.add('was-validated')
                                }, false)
                            })
                    })()
                </script>
            </div>

            <!--NEW  Modal FOR Download BUTTON-->
            <div class="modal fade" id="exampleModals" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabels"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content" style="width:116% !important;">
                        <div class="modal-header" style="border-bottom: 1px solid black;">
                            <h5 class="modal-title" id="exampleModalLabels">Download File &nbsp; <i
                                    class="fa fa-download" aria-hidden="true" style='font-size:18px;'></i></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body">
                            {{prompt}}
                            <form method="POST" enctype="multipart/form-data">
                                <table class="table" style="width:100%;">
                                    <thead>
                                        <tr>
                                            <th style="width:29%;"></th>
                                            <th style="width:29%;">Single File</th>
                                            <th style="width:29%;">Group Wise File</th>
                                            <th style="width:29%;">Share File</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><b>All Record :</b></td>
                                            <td>
                                                <a type="button" class="btn btn-secondary"
                                                {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/download-AllRecords-csv/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}" {% else %} href="/{{IPOid}}/download-AllRecords-csv/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}"{%endif%}>Download &nbsp; <i class="fa fa-download" aria-hidden="true" style='font-size:18px;'></i></a>
                                            </td>
                                            <td>
                                                <a type="button" class="btn btn-secondary"
                                                {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/Group_wise-download-AllRecords-csv/SELL/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}" {% else %} href="/{{IPOid}}/download-AllRecords-csv/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}"{%endif%}>Download &nbsp; <i class="fa fa-download" aria-hidden="true" style='font-size:18px;'></i></a>
                                            </td>
                                            <td>
                                                {% comment %} <a type="button" class="btn btn-secondary" data-toggle="modal" data-target="#shareFileModal" data-record-type="All Record">Share &nbsp; <i class="fa fa-share" aria-hidden="true" style='font-size:18px;'></i></a> {% endcomment %}
                                                <a type="button" class="btn btn-secondary" 
                                                    data-record-type="All Record"
                                                    onclick="openShareModal(this)">
                                                        Share &nbsp; <i class="fa fa-share-alt" aria-hidden="true" style='font-size:18px;'></i>
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><b>Pending PAN :</b></td>
                                            <td>
                                                <a type="button" class="btn btn-secondary"
                                                {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/download-csv/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}" {% else %} href="/{{IPOid}}/download-csv/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}" {%endif%}>Download &nbsp; <i class="fa fa-download" aria-hidden="true" style='font-size:18px;'></i></a>
                                            </td>
                                            <td>
                                                <a type="button" class="btn btn-secondary"
                                                {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/Group_wise-download-csv/SELL/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}" {% else %} href="/{{IPOid}}/download-csv/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}" {%endif%}>Download &nbsp; <i class="fa fa-download" aria-hidden="true" style='font-size:18px;'></i></a>
                                            </td>
                                            <td>
                                                <!-- <a type="button" class="btn btn-secondary" data-toggle="modal" data-target="#shareFileModal" data-record-type="Pending PAN" onclick='Load_shareModel('Pending PAN')'>Share &nbsp; <i class="fa fa-share-alt" aria-hidden="true" style='font-size:18px;'></i></a> -->
                                                <a type="button" class="btn btn-secondary" 
                                                    data-record-type="Pending PAN"
                                                    onclick="openShareModal(this)">
                                                        Share &nbsp; <i class="fa fa-share-alt" aria-hidden="true" style='font-size:18px;'></i>
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </form>
                            {% for profile in entry%}
                            {{profile.name}}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Share File Modal -->
            <div class="modal fade" id="shareFileModal" tabindex="-1" role="dialog" aria-labelledby="shareFileModalLabel" aria-hidden="true" style="margin: 0rem auto;transform: none;">
                <div class="modal-dialog modal-lg" role="document" style="max-width: 90vw;width: auto; margin: 0rem auto;transform: none;">
                    <div class="modal-content" style='max-height: 90vh;overflow-y: auto;'>
                        <div class="modal-header" style="border-bottom: 1px solid black;">
                            <h5 class="modal-title" id="shareFileModalLabel">Share File</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form method="POST" id="shareFileForm">
                                {% csrf_token %}
                                <input type="hidden" id="recordTypeInput" name="record_type" value="">
                                <div class="form-group">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="mb-0">Select Group to Share File:</label>
                                        <button type="button" id="toggleSelectAll" class="btn btn-sm btn-outline-secondary">Select All</button>
                                    </div>
                                    <div id="twoTablesContainer" class="d-flex justify-content-between flex-wrap" style="max-height: 400px; overflow-y: auto;"> <!-- Container for two tables with scroll -->
                                        <div id="tableLeftContainer" class="table-responsive" style="flex: 1; margin-right: 10px;"> <!-- First table container -->
                                            <table class="table table-bordered table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Select</th>
                                                        <th>Group Name</th>
                                                        <th>Email</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="groupTableBodyLeft">
                                                    {# Table rows will be dynamically inserted here by JavaScript #}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div id="tableRightContainer" class="table-responsive" style="flex: 1;"> <!-- Second table container -->
                                            <table class="table table-bordered table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Select</th>
                                                        <th>Group Name</th>
                                                        <th>Email</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="groupTableBodyRight">
                                                    {# Table rows will be dynamically inserted here by JavaScript #}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer" style="border-top: 1px solid black;">
                                    <button type="submit" class="btn btn-primary">Share</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End New Share File Modal -->

            <div class="modal fade" id="IPO_Allotment_Check" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabels"
                aria-hidden="true">

                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header" style="border-bottom: 1px solid black;">
                            <h5 class="modal-title" id="exampleModalLabel">IPO Allotment Check</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="loader" style="display: none;" ></div>
                            {{prompt}}
                            <form id ="ipo_form" method="POST" enctype="multipart/form-data" onsubmit="return validateForm()"
                                class="needs-validation">
                                {% csrf_token %}
                                <small style="color: red;">
                                    <b>
                                        <font color="red">*</font>The process may take a few minutes.Ensure this window remains open until the process is fully completed.
                                    </b>
                                </small><br><br>
                                <div class="form-group">
                                    <label for="ipo_register" ><b>IPO Registrar :</b></label>
                                    <select id="ipo_register" name="ipo_register" class="form-control" required>
                                        <option selected disabled value="">Select IPO Registrar</option>
                                        <option class="transparent-box" value="Linkin">Linkin</option>
                                        <option class="transparent-box"  value="Kfintech">Kfintech</option>
                                        <option class="transparent-box" value="BigShare">BigShare</option>
                                        <option class="transparent-box" value="Purva">Purva</option>
                                        <option class="transparent-box" value="SkyLine">SkyLine</option>
                                        <option class="transparent-box" value="Integrated">Integrated</option>
                                        <option class="transparent-box" value="Maashitla">Maashitla</option>
                                        <option class="transparent-box" value="Cambridge">Cambridge</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="secondary_dropdown" ><b>IPO Name :</b></label>
                                    <select id="secondary_dropdown" name="secondary_dropdown" class="form-control" required>
                                        <option selected disabled value="">Select IPO Name</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="Pannocheck"><b>Selected PANs :</b></label>
                                    <select id="Pannocheck" name="Pannocheck" class="form-control" required>
                                        <option class="transparent-box" value="All Record">All PAN Records (Whole Allotment)</option>
                                        <option class="transparent-box"  value="Pending">Pending PAN Records (Pending Blank Allotment)</option>
                                    </select>

                                </div>
                                <br>
                                <div class="modal-footer" style="border-top: 1px solid black;">
                                    <div class = 'fma'>
                                        <button type="button" class="btn btn-secondary " data-dismiss="modal" data-toggle="modal" data-target="#editbtn">Firm Allotment</button>
                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-outline-primary">Submit </button>
                                    </div>    
                                </div>
                            </form>
                            {% for profile in entry%}
                            {{profile.name}}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- JAVASCRIPT FOR FLIE UPDAT BUTTON FORM VALIDATION -->
                <script>
                    // Example starter JavaScript for disabling form submissions if there are invalid fields
                    (function () {
                        'use strict'

                        // Fetch all the forms we want to apply custom Bootstrap validation styles to
                        var forms = document.querySelectorAll('.needs-validation')

                        // Loop over them and prevent submission
                        Array.prototype.slice.call(forms)
                            .forEach(function (form) {
                                form.addEventListener('submit', function (event) {
                                    if (!form.checkValidity()) {
                                        event.preventDefault()
                                        event.stopPropagation()
                                    }

                                    form.classList.add('was-validated')
                                }, false)
                            })
                    })()
                </script>
                <script>
                    function validateForm() {
                        let ipoRegister = document.getElementById('ipo_register').value;
                        let ipoName = document.getElementById('secondary_dropdown').value;
                        let panNoCheck = document.getElementById('Pannocheck').value;
            
                        if (ipoRegister === "" || ipoName === "" || panNoCheck === "") {
                            alert("All fields are required.");
                            return false;
                        }
                    }
                </script>
                <script>
                    window.addEventListener("load", () => {
                        const loader = document.querySelector(".loader");
                        if (loader) {
                            loader.classList.add("loader-hidden");
                        }
                    });

                    document.addEventListener('DOMContentLoaded', function() {
                        document.getElementById('ipo_register').addEventListener('change', function() {
                            var selectedValue = this.value;
                            var secondaryDropdown = document.getElementById('secondary_dropdown');
            
                            // Clear existing options
                            secondaryDropdown.innerHTML = '';
            
                            // Fetch options from Django view
                            if (selectedValue !== 'Select') {
                                fetch(`/get-options/?ipo_register=${selectedValue}`)
                                .then(response => response.json())
                                .then(data => {
                                    data.forEach(function(option) {
                                        var opt = document.createElement('option');
                                        opt.value = option;
                                        opt.text = option;
                                        secondaryDropdown.add(opt);
                                    });
                                })
                                .catch(error => console.error('Error fetching options:', error));
                            }
                        });
                        document.getElementById('ipo_form').addEventListener('submit',async function(event) {
                            event.preventDefault();
                            
                            const loader = document.querySelector('.loader');
                            const submitButton = document.getElementById('submit_button');
                            if (loader) {
                                loader.style.display = 'block';
                                loader.classList.remove('loader-hidden');
                            }
                            if (submitButton) {
                                submitButton.style.display = 'none';
                            }

                            var IPOid = "{{ IPOid }}";
                            var  IPO_type = '{{IPOName.IPOType}}'
                            
                            var ipoRegister = document.getElementById('ipo_register').value;
                            var ipoName = document.getElementById('secondary_dropdown').value;
                            var Gp_name = document.getElementById('category').value;
                            var IPOTypefilter = document.getElementById('category1').value;
                            if (IPO_type != 'SME'){
                                var InvestorTypeFilter = document.getElementById('category2').value;
                                var actionUrl = `/${IPOid}/SELL/IPO_Allotment/${Gp_name}/${IPOTypefilter}/${InvestorTypeFilter}`;
                                var panurl = `/get_pancards/${IPOid}/SELL/${Gp_name}/${IPOTypefilter}/${InvestorTypeFilter}`
                            }
                            else{
                                var actionUrl = `/${IPOid}/SELL/IPO_Allotment/${Gp_name}/${IPOTypefilter}/All`;
                                var panurl = `/get_pancards/${IPOid}/SELL/${Gp_name}/${IPOTypefilter}/All` 
                            }
                            
                            var words = ipoName.split(' ');
                            // Get the first and second word separately
                            var firstWord = words[0];
                            var secondWord = words.length > 1 ? words[1] : '';

                            // Construct the action URL with selected values
                            //var actionUrl = `/${IPOid}/BUY/IPO_Allotment`;
                            var formData = new FormData(this);

                            let response = await fetch(panurl, {
                                method: 'POST',
                                body: formData
                            });
                            let data = await response.json();

                           if (ipoRegister == 'BigShare' || ipoRegister == 'Maashitla'){
                                part_num = 300;
                            }else if ( ipoRegister == 'Cambridge') {
                                part_num = 50
                            }else{
                                part_num = 500
                            }

                            // Create a FormData object to send the form data
                            let pancardsChunks = [];

                            let numParts = Math.ceil(data.pancards.length / part_num); // Each 500 adds one more part
                            {% comment %} numParts = Math.min(numParts, 4); // Ensure it does not exceed 4 parts {% endcomment %}
                            
                            let chunkSize = Math.ceil(data.pancards.length / numParts);
                            //let chunkSize = Math.ceil(data.pancards.length / 4);  // Divide into 4 roughly equal parts

                            for (let i = 0; i < data.pancards.length ; i+= chunkSize) {
                                pancardsChunks.push(data.pancards.slice(i, i + chunkSize));
                            }
                            this.actionurl = actionUrl

                            let excelBlobs = [];

                            for (let i = 0; i < pancardsChunks.length; i++) {
                                let chunk = pancardsChunks[i];
                                formData.append('pancards', JSON.stringify(chunk));
                                // Send the POST request using fetch
                                try {
                                    let response = await fetch(actionUrl, {
                                        method: 'POST',
                                        body: formData
                                    });
                        
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                        
                                    let blob = await response.blob();
                                    excelBlobs.push(blob);
                        
                                } catch (error) {
                                    console.error('Error:', error);

                                    // Create an Excel blob for the errored chunk with "PAN" and "Remark"
                                    let errorData = chunk.map(pan => ({
                                        PAN: pan,
                                        REMRAK: 'ERROR'
                                    }));

                                    let ws = XLSX.utils.json_to_sheet(errorData);
                                    let wb = XLSX.utils.book_new();
                                    XLSX.utils.book_append_sheet(wb, ws, "Errors");

                                    let buffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                                    let errorBlob = new Blob([buffer], {
                                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                                    });

                                    // Push errorBlob into excelBlobs array so it's merged later
                                    excelBlobs.push(errorBlob);
                                }

                                /* fetch(actionUrl, {
                                    method: 'POST',
                                    body: formData,
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.blob(); // Convert the response to a Blob
                                })
                                .then(blob => {
                                    // Create a URL for the blob object
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.style.display = 'none';
                                    a.href = url;
                                    a.download = `${firstWord}_${secondWord}_IPO_Allotment.xlsx`; // Set the file name
                                    document.body.appendChild(a);
                                    a.click();
                                    window.URL.revokeObjectURL(url);
                                    
                                    // Hide the loader and show the submit button again
                                    if (loader) {
                                        loader.style.display = 'none';
                                    }
                                    if (submitButton) {
                                        submitButton.style.display = 'block';
                                    }

                                    window.location.reload();
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                        
                                    // Hide the loader and show the submit button again in case of error
                                    if (loader) {
                                        loader.style.display = 'none';
                                    }
                                    if (submitButton) {
                                        submitButton.style.display = 'block';
                                    }
                                }); */
                            }
                            if (excelBlobs.length > 0) {
                                mergeAndDownloadExcel(excelBlobs, firstWord, secondWord);
                            }
                            if (loader) {
                                loader.style.display = 'none';
                            }
                            if (submitButton) {
                                submitButton.style.display = 'block';
                            }
                            window.location.reload();
                        });
                        function mergeAndDownloadExcel(blobs, firstWord, secondWord) {
                            let promises = blobs.map(blob => blob.arrayBuffer());
                        
                            Promise.all(promises).then(buffers => {
                                let allHeaders = new Set(); // Store all unique column headers
                                let allData = []; // Store all rows from each file

                                // Step 1: Extract headers from all files
                                let fileData = buffers.map(buffer => {
                                    let data = new Uint8Array(buffer);
                                    let wbPart = XLSX.read(data, { type: 'array' });
                                    let sheetName = wbPart.SheetNames[0]; // Assume data is in the first sheet
                                    let ws = wbPart.Sheets[sheetName];

                                    let sheetData = XLSX.utils.sheet_to_json(ws, { header: 1 }); // Convert to array
                                    if (sheetData.length > 0) {
                                        sheetData[0].forEach(header => allHeaders.add(header)); // Collect unique headers
                                    }
                                    return sheetData;
                                });
                                
                                let unifiedHeaders = Array.from(allHeaders);
                                allData.push(unifiedHeaders); // Set as the first row (header)

                                // Step 3: Normalize each file's data and merge
                                fileData.forEach(sheetData => {
                                    if (sheetData.length > 1) { // Skip if there's no data
                                        let headers = sheetData[0]; // Extract headers from the file
                                        let body = sheetData.slice(1); // Extract data rows

                                        // Create a mapping of column index positions
                                        let columnMap = {};
                                        headers.forEach((col, index) => columnMap[col] = index);

                                        // Normalize rows to match the unified headers
                                        body.forEach(row => {
                                            let normalizedRow = unifiedHeaders.map(header => 
                                                header in columnMap ? row[columnMap[header]] : ""
                                            );
                                            allData.push(normalizedRow);
                                        });
                                    }
                                });

                        
                                let wb = XLSX.utils.book_new();
                                let ws = XLSX.utils.aoa_to_sheet(allData);
                                XLSX.utils.book_append_sheet(wb, ws, "IPO_Allotment");

                                // Step 5: Write and download the merged Excel file
                                let excelArrayBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                                let mergedExcel = new Blob([excelArrayBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                                let url = window.URL.createObjectURL(mergedExcel);
                                let a = document.createElement('a');
                                a.style.display = 'none';
                                a.href = url;
                                a.download = `${firstWord}_${secondWord}_IPO_Allotment.xlsx`;
                                document.body.appendChild(a);
                                a.click();
                                window.URL.revokeObjectURL(url);
                            });
                        }
                    });
                </script>
            </div>

            <div class="modal fade" id="editbtn" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabels"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header" style="border-bottom: 1px solid black;">
                            <h5 class="modal-title" id="exampleModalLabels">Firm Allotment</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            {{prompt}}
                                <form {% if IPOName.IPOType == "MAINBOARD" %} action="/{{IPOid}}/SELL/FirmAllotment/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}" {%else%} action="/{{IPOid}}/SELL/FirmAllotment/{{Groupfilter}}/{{IPOTypefilter}}/All" {%endif%} id="form-id2" method="POST"
                                enctype="multipart/form-data" style="margin: 15px 22px;" class="needs-validation"
                                novalidate>
                                {% csrf_token %}
                                <label><b>Group : </b></label>
                                <select id="category3" class="form-control" name="Group" autofocus="autofocus"
                                onfocus="this.select()" style="height: 37px;">
                                <option selected value="All">All</option>
                                {% for i in Group %}
                                <option {% if Groupfilter in i.GroupName %} selected {%else%} {% endif %}
                                    value="{{ i.GroupName }}">
                                    {{i.GroupName }}
                                </option>
                                {% endfor %}
                                </select><br>

                                <!-- <label for="category"><b>Order Category : </b></label>
                                <select id="category" class="form-control" name="IPOCategory" >
                                    <option {% if IPOTypefilter == 'All' or IPOTypefilter == 'None' %} selected {% endif %} value="All">All</option>
                                    <option {% if IPOTypefilter == 'Kostak'%} selected {% endif %} value="Kostak">Kostak</option>
                                    <option {% if IPOTypefilter == 'Subject To'%} selected {% endif %} value="Subject To">Subject To</option>
                                </select>
                                <br> -->
            
                                {% if IPOName.IPOType == "MAINBOARD" %} 
                                    <label for="category"><b>Investor Type : </b></label>
                                    <select id="category4" class="form-control" name="InvestorType" >
                                        <option {% if InvestorTypeFilter == 'All' or InvestorTypeFilter == 'None' %} selected {% endif %} value="All">All</option>
                                        <option {% if InvestorTypeFilter == 'RETAIL'%} selected {% endif %} value="RETAIL">Retail (Kostak + Subject To)</option>
                                        <option {% if InvestorTypeFilter == 'SHNI'%} selected {% endif %} value="SHNI">SHNI (Kostak + Subject To)</option>
                                        <option {% if InvestorTypeFilter == 'BHNI'%} selected {% endif %} value="BHNI">BHNI (Kostak + Subject To)</option>
                                        <!-- <option {% if InvestorTypeFilter == 'PREMIUM' %} selected {% endif %} value="PREMIUM">Premium</option> -->
                                    </select>
                                    <br>
                                {%endif%}

                                <label for="category"><b>Alloted QTY :</b></label>
                                <input type="text" name="AllotedQty"
                                    oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..?)\../g, '$1');" / style="height: 37px;">
                                <br><br>

                                <div class="modal-footer" style="border-top: 1px solid black;">
                                    <button type="submit" class="btn btn-outline-primary">Submit </button>
                                </div>

                                </form>

                            {% for profile in entry%}
                            {{profile.name}}
                            {% endfor %}
                        </div>
                    </div>
                    <!-- JAVASCRIPT FOR FLIE UPDAT BUTTON FORM VALIDATION -->
                    <script>
                        // Example starter JavaScript for disabling form submissions if there are invalid fields
                        (function () {
                            'use strict'

                            // Fetch all the forms we want to apply custom Bootstrap validation styles to
                            var forms = document.querySelectorAll('.needs-validation')

                            // Loop over them and prevent submission
                            Array.prototype.slice.call(forms)
                                .forEach(function (form) {
                                    form.addEventListener('submit', function (event) {
                                        if (!form.checkValidity()) {
                                            event.preventDefault()
                                            event.stopPropagation()
                                        }

                                        form.classList.add('was-validated')
                                    }, false)
                                })
                        })()
                    </script>
                </div>
           </div>

        </div>
    </div>

    <script src="{% static 'JS/sorttable.js' %}"></script>
    <div class="table-responsive text-nowrap">
    <table id="bootstrapdatatable" class="table table-hover table-bordered" style="margin-bottom: 1%;">
        <thead>
        </thead>
        <tbody>
            <tr>
                <th style='text-align: inherit; width: 25%;'>
                    Total Application
                </th>
                <td class="tablecenter" style='width: 25%;'>
                    {{AppTotal}}
                </td>
                <th class="tablelinel" style='text-align: inherit;width: 25%;'>
                    Pending PAN
                </th>
                <td class="tablecenter" style='width: 25%;'>
                    <a class="tablecenter"
                                {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/download-csv/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}" {% else %} href="/{{IPOid}}/download-csv/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}" {%endif%}>
                                {{Appwithoutpan}}</a>
                    
                </td>
            </tr>
        </tbody>
    </table>
    </div>
    <form method="POST" {% if IPOName.IPOType == "MAINBOARD" %} action="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}" {% else %} action="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}" {%endif%}>  <!-- Adjust the action URL as necessary -->
        {% csrf_token %}
        <label for="page_size">Show
        <select name="page_size" id="page_size" onchange="this.form.submit()">
            <option value="{{page_size}}" style='display:None;' {% if page_size|default_if_none:50 == 50 %}selected{% endif %}>{{page_size}}</option>
            <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
            <option value="200" {% if page_size == 200 %}selected{% endif %}>200</option>
            <option value="250" {% if page_size == 250 %}selected{% endif %}>250</option>
            <option value="All" {% if page_size == 'All' %}selected{% endif %}>All</option>
        </select>
        Rows</label>
        <input type="hidden" name="page" value="{{ page_obj.number }}">
        <!-- Include other necessary filters here -->
    </form>
    <form {% if IPOName.IPOType == "MAINBOARD" %} action="/{{ IPOid }}/SELL/update_pann/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}?page={{ page_obj.number }}"  {% else %} action="/{{ IPOid }}/SELL/update_pann/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}?page={{ page_obj.number }}" {%endif%} method='POST' style='margin-top:-2%' onsubmit="return validatePANs()">
        {% csrf_token %}
        <div style='text-align: right; margin-top: 0%;margin-bottom: 1%;'>
            <button class='btn btn-outline-primary' type='submit' style='width: 100px;'>Update</button>
        </div>
    <div class="table-responsive text-nowrap">
    <table class="table-bordered table-hover sortable" id="sortable-table">
        {{ html_table | safe }}
    </table>
    </div>
    </form>
    <div class="row">
        <div class="col-md-6">
            <!-- Total rows and current range display (left aligned) -->
            <p class="text-left">
                Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} Rows
            </p>
        </div>
        
        {% comment %} <div class="col-md-6 ">
            <div class="pagination-wrapper">
                <ul class="pagination">
                    <div class="row text-right" style='margin-left:61%'>
                        <li class="page-item">
                            <a class="page-link" {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}?page=1" {% else %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}?page=1" {%endif%}>First</a>
                        </li>
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}?page={{ page_obj.previous_page_number }}" {% else %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}?page={{ page_obj.paginator.num_pages }}"{%endif%}>Previous</a>
                            </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Previous</span>
                                </li>
                        {% endif %}
                        <li class="page-item active">
                            <a class="page-link">{{ page_obj.number }}</a>
                        </li>
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}?page={{ page_obj.next_page_number }}" {% else %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}?page={{ page_obj.paginator.num_pages }}" {%endif%}>Next</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Next</span>
                            </li>
                        {% endif %}
                            <li class="page-item">
                                <a class="page-link" {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}?page={{ page_obj.paginator.num_pages }}" {% else %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}?page={{ page_obj.paginator.num_pages }}" {%endif%}>Last</a>
                            </li>
                    </div>
                </ul>
            </div>
        </div> {% endcomment %}

        <div class="col-md-6">
            <ul class="pagination justify-content-end text-left" style="margin: 0; margin-right:2%;">
                <!-- Always show the first page -->
                {% if page_obj.number != 1 %}
                    <li class="page-item">
                        <a class="page-link" {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}?page=1" {% else %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}?page=1" {%endif%}>1</a>
                    </li>
                {% endif %}
                
                <!-- Show ellipsis if current page is greater than 4 -->
                {% if page_obj.number > 4 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
                
                <!-- Display pages before the current page -->
                {% for num in page_obj.paginator.page_range %}
                    {% if num > 1 and num < page_obj.number and num >= page_obj.number|add:'-2' %}
                        <li class="page-item">
                            <a class="page-link" {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}?page={{ num }}" {% else %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}?page={{ num }}" {%endif%}>{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                <!-- Display current page -->
                <li class="page-item active">
                    <span class="page-link">{{ page_obj.number }}</span>
                </li>
                
                <!-- Display pages after the current page -->
                {% for num in page_obj.paginator.page_range %}
                    {% if num > page_obj.number and num < page_obj.number|add:'3' and num < page_obj.paginator.num_pages %}
                        <li class="page-item">
                            <a class="page-link" {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}?page={{ num }}" {% else %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}?page={{ num }}" {%endif%}>{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                <!-- Show ellipsis if current page is less than num_pages - 3 -->
                {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
                
                <!-- Always show the last page -->
                {% if page_obj.number != page_obj.paginator.num_pages %}
                    <li class="page-item">
                        <a class="page-link" {% if IPOName.IPOType == "MAINBOARD" %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/{{InvestorTypeFilter}}/{{OrderDate}}/{{OrderTime}}?page={{ page_obj.paginator.num_pages }}" {% else %} href="/{{IPOid}}/OrderDetail/SELL/{{Groupfilter}}/{{IPOTypefilter}}/All/{{OrderDate}}/{{OrderTime}}?page={{ page_obj.paginator.num_pages }}" {%endif%}>{{ page_obj.paginator.num_pages }}</a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>

</div>
                        <!-- <button type="button" class="btn btn-outline-danger"
                            onclick="document.getElementById('{{ i.id }}').style.display='block'" style="width: 72px;"
                            data-toggle="modal" data-target="#{{ i.id }}">Delete</button> -->

                        <!--NEW  Modal FOR Download BUTTON-->
                        {% comment %} <div class="modal fade" id="{{ i.id }}" tabindex="-1" role="dialog"
                            aria-labelledby="exampleModalLabels" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header" style="border-bottom: 1px solid black;">
                                        <b>
                                            <h5 class="modal-title" id="exampleModalLabel">Delete IPO</h5>
                                        </b>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        {{prompt}}
                                        <center>
                                            <p>Are you sure you want to delete Order?</p>

                                            <div class="clearfix">
                                                <button type="button" class="btn btn-outline-secondary"
                                                    data-dismiss="modal" style="margin-right: 60px; width: 25%;"
                                                    class="cancelbtn">Cancel</button>
                                                <button type="button" class="btn btn-outline-danger"
                                                    style="margin-left:-20px; width: 25%;" class="deletebtn"
                                                    onclick="window.location.href='/DeleteOrder/{{ IPOid }}/{{i.id}}';"
                                                    autofocus="autofocus" onfocus="this.select()">Delete</button>
                                        </center>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            </form>
            {% endfor %}
        </tbody>
    </table>
    </div>

</div> {% endcomment %}


<div class="footer">
    {% comment %} <a href="/{{IPOid}}/SetRate" class="btn button btn-dark"><span>Set Rate</span></a> {% endcomment %}
    <a href="/{{IPOid}}/BUY" class="btn button btn-dark"><span>BUY</span></a>
    <a href="/{{IPOid}}/SELL" class="btn button btn-dark"><span>SELL</span></a>
    <a href="/{{IPOid}}/Order" class="btn button btn-dark"><span>Orders</span></a>
    <a href="/{{IPOid}}/OrderDetail/BUY" class="btn button btn-dark" style="white-space: nowrap;"><span>App. Buy Order (PAN)</span></a>
    <a href="/{{IPOid}}/OrderDetail/SELL" class="btn button btn-dark disabled" style="white-space: nowrap;"><span>App. Sell Order (PAN)</span></a>
    <a href="/{{IPOid}}/Billing" class="btn button btn-dark"><span>Client Wise Billing</span></a>
    <a href="/{{IPOid}}/Status" class="btn button btn-dark"><span>Group Wise Billing</span></a>
    <a href="/{{IPOid}}/Dashboard/A" class="btn button btn-dark"><span>Analysis</span></a>
    <!-- <a href="PremiumBilling" class="btn button btn-dark" style="white-space: nowrap;"><span>Premium Billing</span></a> -->
</div>

<script src="{% static 'JS/jquery-1.12.4.js' %}"></script>
<script src="{% static 'JS/jquery-ui.js' %}"></script>

<script>

    $("#bootstrapdatatable").delegate("#PAN", "focusout", function () {
        var closestTR = $(this).closest('tr');
        var value = closestTR.find('#PAN').val();
        if (value.trim() == '') {
            closestTR.find('.invalid-feedback').show();

        } else {
            closestTR.find('.invalid-feedback').hide
        }
    });

</script>


{% comment %} <script>
    var id;
    function functiontest(ar){
        id=ar
    }
    $(function function12 () {
        var value1 = $(".auto").autocomplete({
            source: "{% url 'autocomplete' %}",
            select:function myFunction(e,ui) {
                if (ui.item.value) {
                var x = ui.item.value
                var s = x.split('-')
                ui.item.value = s[0];
                var n = document.getElementById(id);
                n.value=s[1]
                }
              }
        });
    });
</script> {% endcomment %}

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const getCellValue = (cell, type) => {
            if (type === "input" && cell.querySelector("input")) {
                return cell.querySelector("input").value;
            }
            return cell.textContent || cell.innerText;
        };

        const sortTable = (table, colIndex, sortType, ascending) => {
            const rows = Array.from(table.querySelectorAll("tbody > tr"));
            const sortedRows = rows.sort((a, b) => {
                const cellA = getCellValue(a.cells[colIndex], sortType);
                const cellB = getCellValue(b.cells[colIndex], sortType);

                if (sortType === "number") {
                    return ascending ? parseFloat(cellA) - parseFloat(cellB) : parseFloat(cellB) - parseFloat(cellA);
                }
                return ascending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });

            rows.forEach(row => table.querySelector("tbody").appendChild(row));
        };

        document.querySelectorAll("#sortable-table th").forEach((header, index) => {
            let ascending = true; // Default sort order is ascending
            header.addEventListener("click", () => {
                const sortType = header.getAttribute("data-sort") || "text";
                sortTable(document.querySelector("#sortable-table"), index, sortType, ascending);
                ascending = !ascending; // Toggle the sort order
            });
        });
    });
</script>

<script>
    function validatePANs() {
        const panPattern = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
        let isValid = true;
        let firstInvalidInput = null; // Track the first invalid input field
      
        // Loop through all PAN input fields in the table
        document.querySelectorAll("input[name^='PAN_']").forEach(input => {
          const panId = input.id.split('_')[1];
          const tooltip = document.getElementById(`tooltip_${panId}`);
          
          // Validate only if the field is not blank
          if (input.value.toUpperCase() && !panPattern.test(input.value.toUpperCase())) {
            tooltip.style.display = 'block';
            isValid = false;

            if (!firstInvalidInput) {
                firstInvalidInput = input;
                input.focus();
                setTimeout(() => { tooltip.style.display = 'block'; }, 0);

            }
          } else {
            tooltip.style.display = 'none';
          }
        });

        return isValid;
    }
      
      // Validate each PAN field individually on blur
    function checkPAN(id) {
        const input = document.getElementById(`PAN_${id}`);
        const tooltip = document.getElementById(`tooltip_${id}`);
        const panPattern = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
      
        // Show error only if the field is not blank and is invalid
        if (input.value.toUpperCase() && !panPattern.test(input.value.toUpperCase())) {
          tooltip.style.display = 'block';
        } else {
          tooltip.style.display = 'none';
        }
    }
    function sanitizeInput(elem) {
        elem.value = elem.value.replace(/[^a-zA-Z0-9.\-&/@_ ]/g, '');
    }

    // Show tooltip if invalid characters exist
    function checkValidChars(elem, tooltipId) {
        const tooltip = document.getElementById(tooltipId);
        const pattern = /^[a-zA-Z0-9.\-&/@_ ]*$/;

        if (!pattern.test(elem.value)) {
            tooltip.style.display = 'block';
            elem.style.border = '1px solid red';
        } else {
            tooltip.style.display = 'none';
            elem.style.border = '';
        }
    }
      
      // Hide tooltip on focus
    function hideTooltip(id) {
        const tooltip = document.getElementById(`tooltip_${id}`);
        tooltip.style.display = 'none';
    }
</script>
<script>
    function openShareModal(element) {
        var recordType = element.getAttribute("data-record-type");
        
        $('#shareFileModal').modal('show');

        $('#shareFileModal').on('shown.bs.modal', function () {
            $('#recordTypeInput').val(recordType);
            var groupData;
            if (recordType == 'Pending PAN') {
                groupData = JSON.parse('{{ Panding_Pan_GroupList|safe }}');
            } else {
                groupData = JSON.parse('{{ group_names_list|safe }}');
            }

            var tableBodyLeft = document.getElementById('groupTableBodyLeft');
            var tableBodyRight = document.getElementById('groupTableBodyRight');
            var tableRightContainer = document.getElementById('tableRightContainer');
            var twoTablesContainer = document.getElementById('twoTablesContainer');

            tableBodyLeft.innerHTML = ''; // Clear existing rows
            tableBodyRight.innerHTML = ''; // Clear existing rows

            const rowThreshold = 15; // Set your desired threshold for splitting the table

            if (groupData.length > rowThreshold) {
                // Split into two tables
                var mid = Math.ceil(groupData.length / 2);
                var leftHalf = groupData.slice(0, mid);
                var rightHalf = groupData.slice(mid);

                leftHalf.forEach(function(group) {
                    var row = tableBodyLeft.insertRow();
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);

                    cell1.innerHTML = `<input type="checkbox" name="selected_groups"
                                            value="${group.group_name}"
                                            data-group-name="${group.group_name}"
                                            data-group-email="${group.Group_emial || ''}">`;
                    cell2.textContent = group.group_name;
                    cell3.textContent = group.Group_emial || '';
                });

                rightHalf.forEach(function(group) {
                    var row = tableBodyRight.insertRow();
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);

                    cell1.innerHTML = `<input type="checkbox" name="selected_groups"
                                            value="${group.group_name}"
                                            data-group-name="${group.group_name}"
                                            data-group-email="${group.Group_emial || ''}">`;
                    cell2.textContent = group.group_name;
                    cell3.textContent = group.Group_emial || '';
                });

                tableRightContainer.style.display = 'block'; // Ensure right table is visible
                twoTablesContainer.classList.add('d-flex'); // Ensure flex display
                twoTablesContainer.style.marginRight = '10px'; // Add margin back if removed
            } else {
                // Display as a single table
                groupData.forEach(function(group) {
                    var row = tableBodyLeft.insertRow();
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);

                    cell1.innerHTML = `<input type="checkbox" name="selected_groups"
                                            value="${group.group_name}"
                                            data-group-name="${group.group_name}"
                                            data-group-email="${group.Group_emial || ''}">`;
                    cell2.textContent = group.group_name;
                    cell3.textContent = group.Group_emial || '';
                });

                tableRightContainer.style.display = 'none'; // Hide the right table container
                twoTablesContainer.classList.remove('d-flex'); // Remove flex display for single column
                twoTablesContainer.style.marginRight = '0'; // Remove margin
            }
        });

    }

    $(document).ready(function () {
        
        // On form submission
        $('#shareFileForm').submit(function (event) {
            event.preventDefault(); // prevent actual submission

            var selectedGroupsData = [];
            $('input[name="selected_groups"]:checked').each(function() {
                var groupName = $(this).data('group-name');
                var groupEmail = $(this).data('group-email');
                selectedGroupsData.push({
                    name: groupName,
                    email: groupEmail
                });
            });
            var recordType = $('#recordTypeInput').val(); 
            var IPO_id = '{{IPOid}}'

            $.ajax({
                url: '/share-records/',
                method: 'POST',
                data: {
                    'selected_records': JSON.stringify(selectedGroupsData), // Send as JSON string
                    'record_type': recordType,
                    'IPO_id':IPO_id,
                    'OrderType' : 'SELL'

                },
                success: function (response) {
                    window.location.reload();
                },
                error: function (error) {
                    alert('Error sharing records.');
                    console.error(error);
                }
            });
        });
        $('#shareFileModal .close').on('click', function() {
            $(this).blur(); // Remove focus from the close button
            $('#shareFileModal').modal('hide');
        });
        $('#exampleModals .close').on('click', function() {
            $(this).blur(); // Remove focus from the close button
            $('#exampleModals').modal('hide');
        });
        $('#toggleSelectAll').on('click', function() {
            var allCheckboxes_right = $('#groupTableBodyRight input[type="checkbox"]');
            var allCheckboxes_left = $('#groupTableBodyLeft input[type="checkbox"]');
            var allChecked_left = allCheckboxes_left.length === allCheckboxes_left.filter(':checked').length;
            var allChecked_right = allCheckboxes_right.length === allCheckboxes_right.filter(':checked').length;
            
            if (allChecked_left) {
                allCheckboxes_left.prop('checked', false);
                $(this).text('Select All');
            } else {
                allCheckboxes_left.prop('checked', true);
                $(this).text('Deselect All');
            }
            if (allChecked_right) {
                allCheckboxes_right.prop('checked', false);
                $(this).text('Select All');
            } else {
                allCheckboxes_right.prop('checked', true);
                $(this).text('Deselect All');
            }
        });
    });
</script>
<script>
    function sendPostRequest(ipoId, orderGroup,IPOTypefilter,InvestorTypeFilter,Ordtyp) {
        // Create a hidden form dynamically
        var form = document.createElement('form');
        form.method = 'POST';
        // Set the action to your Django Billing view URL
        // Based on your urls.py, it appears to be '/{{IPOid}}/OrderDetail/SELL'
        form.action = '/'+ ipoId + '/OrderDetail/'+ Ordtyp  ; 

        // Add CSRF token as a hidden input
        var csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}'; // Django's CSRF token
        form.appendChild(csrfInput);

        // Add Groupfilter as a hidden input
        var groupFilterInput = document.createElement('input');
        groupFilterInput.type = 'hidden';
        groupFilterInput.name = 'Groupfilter';
        groupFilterInput.value = orderGroup;
        form.appendChild(groupFilterInput);

        // Add other filters. Set them to 'All' or retrieve their current values
        // from existing filter inputs on the page if you want to preserve them.
        var ipoTypeFilterInput = document.createElement('input');
        ipoTypeFilterInput.type = 'hidden';
        ipoTypeFilterInput.name = 'IPOTypefilter';
        ipoTypeFilterInput.value = IPOTypefilter; // Or get value from an existing element: document.getElementById('your_ipo_type_filter_id').value;
        form.appendChild(ipoTypeFilterInput);

        var investorTypeFilterInput = document.createElement('input');
        investorTypeFilterInput.type = 'hidden';
        investorTypeFilterInput.name = 'InvestorTypeFilter';
        investorTypeFilterInput.value = InvestorTypeFilter; // Or get value from an existing element: document.getElementById('your_investor_type_filter_id').value;
        form.appendChild(investorTypeFilterInput);

        // Append the form to the body and submit it
        document.body.appendChild(form);
        form.submit();
    }
</script>


{% endblock %}